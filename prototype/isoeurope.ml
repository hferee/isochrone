(* ocamlopt graphics.cmxa isoeurope.ml -o isoeurope *)

open Graphics
open Printf

let d = Array.make_matrix 22 22 (10000)
let p = Array.make 22 (0.,0.)

let () =
  d.(0).(1) <- 267; d.(0).(10) <- 284; d.(0).(11) <- 289; d.(0).(12) <- 288; d.(0).(13) <- 336;
  d.(0).(14) <- 297; d.(0).(15) <- 261; d.(0).(16) <- 129; d.(0).(17) <- 82; d.(0).(18) <- 243;
  d.(0).(19) <- 304; d.(0).(2) <- 312; d.(0).(20) <- 304; d.(0).(21) <- 357; d.(0).(3) <- 313;
  d.(0).(4) <- 138; d.(0).(5) <- 293; d.(0).(6) <- 368; d.(0).(7) <- 260; d.(0).(8) <- 318;
  d.(0).(9) <- 329; d.(10).(0) <- 285; d.(10).(1) <- 314; d.(10).(11) <- 301; d.(10).(12) <- 265;
  d.(10).(13) <- 313; d.(10).(14) <- 324; d.(10).(15) <- 328; d.(10).(16) <- 283; d.(10).(17) <- 288;
  d.(10).(18) <- 290; d.(10).(19) <- 246; d.(10).(2) <- 157; d.(10).(20) <- 366; d.(10).(21) <- 324;
  d.(10).(3) <- 265; d.(10).(4) <- 269; d.(10).(5) <- 300; d.(10).(6) <- 356; d.(10).(7) <- 327;
  d.(10).(8) <- 325; d.(10).(9) <- 361; d.(11).(0) <- 296; d.(11).(1) <- 250; d.(11).(10) <- 307;
  d.(11).(12) <- 262; d.(11).(13) <- 284; d.(11).(14) <- 195; d.(11).(15) <- 264; d.(11).(16) <- 264;
  d.(11).(17) <- 284; d.(11).(18) <- 246; d.(11).(19) <- 252; d.(11).(2) <- 350; d.(11).(20) <- 312;
  d.(11).(21) <- 325; d.(11).(3) <- 281; d.(11).(4) <- 285; d.(11).(5) <- 246; d.(11).(6) <- 316;
  d.(11).(7) <- 263; d.(11).(8) <- 271; d.(11).(9) <- 297; d.(12).(0) <- 278; d.(12).(1) <- 272;
  d.(12).(10) <- 264; d.(12).(11) <- 267; d.(12).(13) <- 284; d.(12).(14) <- 285; d.(12).(15) <- 281;
  d.(12).(16) <- 256; d.(12).(17) <- 294; d.(12).(18) <- 261; d.(12).(19) <- 219; d.(12).(2) <- 327;
  d.(12).(20) <- 329; d.(12).(21) <- 43; d.(12).(3) <- 176; d.(12).(4) <- 262; d.(12).(5) <- 253;
  d.(12).(6) <- 318; d.(12).(7) <- 283; d.(12).(8) <- 291; d.(12).(9) <- 319; d.(13).(0) <- 344;
  d.(13).(1) <- 283; d.(13).(10) <- 330; d.(13).(11) <- 285; d.(13).(12) <- 290; d.(13).(14) <- 283;
  d.(13).(15) <- 397; d.(13).(16) <- 307; d.(13).(17) <- 432; d.(13).(18) <- 330; d.(13).(19) <- 375;
  d.(13).(2) <- 378; d.(13).(20) <- 430; d.(13).(21) <- 401; d.(13).(3) <- 274; d.(13).(4) <- 347;
  d.(13).(5) <- 244; d.(13).(6) <- 234; d.(13).(7) <- 406; d.(13).(8) <- 379; d.(13).(9) <- 290;
  d.(14).(0) <- 292; d.(14).(1) <- 237; d.(14).(10) <- 323; d.(14).(11) <- 188; d.(14).(12) <- 278;
  d.(14).(13) <- 290; d.(14).(15) <- 245; d.(14).(16) <- 265; d.(14).(17) <- 372; d.(14).(18) <- 252;
  d.(14).(19) <- 268; d.(14).(2) <- 371; d.(14).(20) <- 288; d.(14).(21) <- 389; d.(14).(5) <- 172;
  d.(14).(6) <- 308; d.(14).(7) <- 249; d.(14).(8) <- 282; d.(14).(9) <- 278; d.(15).(0) <- 266;
  d.(15).(1) <- 155; d.(15).(10) <- 332; d.(15).(11) <- 272; d.(15).(12) <- 291; d.(15).(13) <- 399;
  d.(15).(14) <- 255; d.(15).(16) <- 249; d.(15).(17) <- 264; d.(15).(18) <- 257; d.(15).(19) <- 287;
  d.(15).(2) <- 350; d.(15).(20) <- 227; d.(15).(21) <- 398; d.(15).(3) <- 296; d.(15).(4) <- 289;
  d.(15).(5) <- 266; d.(15).(6) <- 322; d.(15).(7) <- 153; d.(15).(8) <- 281; d.(15).(9) <- 262;
  d.(16).(0) <- 125; d.(16).(1) <- 245; d.(16).(10) <- 282; d.(16).(11) <- 257; d.(16).(12) <- 256;
  d.(16).(13) <- 309; d.(16).(14) <- 265; d.(16).(15) <- 244; d.(16).(17) <- 214; d.(16).(18) <- 139;
  d.(16).(19) <- 272; d.(16).(2) <- 315; d.(16).(20) <- 287; d.(16).(21) <- 350; d.(16).(3) <- 291;
  d.(16).(4) <- 88; d.(16).(5) <- 266; d.(16).(6) <- 342; d.(16).(7) <- 238; d.(16).(8) <- 301;
  d.(16).(9) <- 307; d.(17).(0) <- 83; d.(17).(1) <- 276; d.(17).(10) <- 283; d.(17).(11) <- 288;
  d.(17).(12) <- 292; d.(17).(13) <- 420; d.(17).(14) <- 367; d.(17).(15) <- 250; d.(17).(16) <- 230;
  d.(17).(18) <- 258; d.(17).(19) <- 390; d.(17).(2) <- 311; d.(17).(20) <- 395; d.(17).(21) <- 404;
  d.(17).(3) <- 327; d.(17).(4) <- 255; d.(17).(5) <- 387; d.(17).(6) <- 458; d.(17).(7) <- 254;
  d.(17).(8) <- 408; d.(17).(9) <- 424; d.(18).(0) <- 238; d.(18).(1) <- 227; d.(18).(10) <- 289;
  d.(18).(11) <- 214; d.(18).(12) <- 258; d.(18).(13) <- 311; d.(18).(14) <- 252; d.(18).(15) <- 251;
  d.(18).(16) <- 104; d.(18).(17) <- 256; d.(18).(19) <- 259; d.(18).(2) <- 332; d.(18).(20) <- 289;
  d.(18).(21) <- 347; d.(18).(3) <- 273; d.(18).(4) <- 195; d.(18).(5) <- 248; d.(18).(6) <- 344;
  d.(18).(7) <- 185; d.(18).(8) <- 278; d.(18).(9) <- 309; d.(19).(0) <- 192; d.(19).(1) <- 163;
  d.(19).(10) <- 145; d.(19).(11) <- 145; d.(19).(12) <- 114; d.(19).(13) <- 257; d.(19).(14) <- 163;
  d.(19).(16) <- 172; d.(19).(17) <- 301; d.(19).(18) <- 154; d.(19).(2) <- 203; d.(19).(20) <- 305;
  d.(19).(21) <- 188; d.(19).(3) <- 69; d.(19).(4) <- 173; d.(19).(5) <- 129; d.(19).(6) <- 160;
  d.(19).(7) <- 181; d.(19).(8) <- 139; d.(19).(9) <- 295; d.(1).(0) <- 274; d.(1).(10) <- 326;
  d.(1).(11) <- 261; d.(1).(12) <- 285; d.(1).(13) <- 293; d.(1).(14) <- 233; d.(1).(15) <- 158;
  d.(1).(16) <- 252; d.(1).(17) <- 278; d.(1).(18) <- 235; d.(1).(19) <- 281; d.(1).(2) <- 369;
  d.(1).(20) <- 261; d.(1).(21) <- 392; d.(1).(3) <- 305; d.(1).(4) <- 289; d.(1).(5) <- 250;
  d.(1).(6) <- 315; d.(1).(7) <- 105; d.(1).(8) <- 275; d.(1).(9) <- 276; d.(20).(0) <- 303;
  d.(20).(1) <- 257; d.(20).(10) <- 374; d.(20).(11) <- 314; d.(20).(12) <- 338; d.(20).(13) <- 456;
  d.(20).(14) <- 297; d.(20).(15) <- 226; d.(20).(16) <- 301; d.(20).(17) <- 396; d.(20).(18) <- 288;
  d.(20).(19) <- 419; d.(20).(2) <- 407; d.(20).(21) <- 445; d.(20).(3) <- 363; d.(20).(4) <- 336;
  d.(20).(5) <- 298; d.(20).(6) <- 348; d.(20).(7) <- 265; d.(20).(8) <- 313; d.(20).(9) <- 289;
  d.(21).(0) <- 291; d.(21).(1) <- 336; d.(21).(10) <- 269; d.(21).(11) <- 269; d.(21).(12) <- 43;
  d.(21).(13) <- 342; d.(21).(14) <- 343; d.(21).(15) <- 345; d.(21).(16) <- 301; d.(21).(17) <- 352;
  d.(21).(18) <- 308; d.(21).(19) <- 234; d.(21).(2) <- 317; d.(21).(20) <- 393; d.(21).(3) <- 245;
  d.(21).(4) <- 296; d.(21).(5) <- 317; d.(21).(6) <- 334; d.(21).(7) <- 341; d.(21).(8) <- 349;
  d.(21).(9) <- 383; d.(2).(0) <- 292; d.(2).(1) <- 346; d.(2).(10) <- 155; d.(2).(11) <- 338;
  d.(2).(12) <- 302; d.(2).(13) <- 360; d.(2).(14) <- 361; d.(2).(15) <- 340; d.(2).(16) <- 305;
  d.(2).(17) <- 295; d.(2).(18) <- 322; d.(2).(19) <- 298; d.(2).(20) <- 393; d.(2).(21) <- 361;
  d.(2).(3) <- 312; d.(2).(4) <- 296; d.(2).(5) <- 342; d.(2).(6) <- 398; d.(2).(7) <- 344;
  d.(2).(8) <- 377; d.(2).(9) <- 413; d.(3).(0) <- 323; d.(3).(1) <- 305; d.(3).(10) <- 274;
  d.(3).(11) <- 287; d.(3).(12) <- 176; d.(3).(13) <- 279; d.(3).(15) <- 296; d.(3).(16) <- 304;
  d.(3).(17) <- 334; d.(3).(18) <- 278; d.(3).(19) <- 70; d.(3).(2) <- 337; d.(3).(20) <- 367;
  d.(3).(21) <- 234; d.(3).(4) <- 315; d.(3).(5) <- 271; d.(3).(6) <- 298; d.(3).(7) <- 323;
  d.(3).(8) <- 278; d.(3).(9) <- 342; d.(4).(0) <- 140; d.(4).(1) <- 271; d.(4).(10) <- 276;
  d.(4).(11) <- 283; d.(4).(12) <- 275; d.(4).(13) <- 330; d.(4).(14) <- 296; d.(4).(15) <- 275;
  d.(4).(16) <- 82; d.(4).(17) <- 229; d.(4).(18) <- 194; d.(4).(19) <- 281; d.(4).(2) <- 304;
  d.(4).(20) <- 323; d.(4).(21) <- 339; d.(4).(3) <- 305; d.(4).(5) <- 287; d.(4).(6) <- 368;
  d.(4).(7) <- 269; d.(4).(8) <- 327; d.(4).(9) <- 333; d.(5).(0) <- 290; d.(5).(1) <- 239;
  d.(5).(10) <- 286; d.(5).(11) <- 176; d.(5).(12) <- 255; d.(5).(13) <- 243; d.(5).(14) <- 174;
  d.(5).(15) <- 253; d.(5).(16) <- 263; d.(5).(17) <- 366; d.(5).(18) <- 250; d.(5).(19) <- 241;
  d.(5).(2) <- 354; d.(5).(20) <- 291; d.(5).(21) <- 362; d.(5).(3) <- 260; d.(5).(4) <- 298;
  d.(5).(6) <- 270; d.(5).(7) <- 257; d.(5).(8) <- 155; d.(5).(9) <- 261; d.(6).(0) <- 381;
  d.(6).(1) <- 310; d.(6).(10) <- 377; d.(6).(11) <- 322; d.(6).(12) <- 331; d.(6).(13) <- 249;
  d.(6).(14) <- 320; d.(6).(15) <- 319; d.(6).(16) <- 354; d.(6).(17) <- 482; d.(6).(18) <- 346;
  d.(6).(19) <- 282; d.(6).(2) <- 425; d.(6).(20) <- 352; d.(6).(21) <- 405; d.(6).(3) <- 306;
  d.(6).(4) <- 389; d.(6).(5) <- 281; d.(6).(7) <- 437; d.(6).(8) <- 311; d.(6).(9) <- 312;
  d.(7).(0) <- 266; d.(7).(1) <- 104; d.(7).(10) <- 327; d.(7).(11) <- 267; d.(7).(12) <- 286;
  d.(7).(13) <- 409; d.(7).(14) <- 260; d.(7).(15) <- 154; d.(7).(16) <- 244; d.(7).(17) <- 259;
  d.(7).(18) <- 192; d.(7).(19) <- 287; d.(7).(2) <- 355; d.(7).(20) <- 262; d.(7).(21) <- 398;
  d.(7).(3) <- 316; d.(7).(4) <- 284; d.(7).(5) <- 266; d.(7).(6) <- 442; d.(7).(8) <- 286;
  d.(7).(9) <- 282; d.(8).(0) <- 329; d.(8).(1) <- 268; d.(8).(10) <- 335; d.(8).(11) <- 275;
  d.(8).(12) <- 295; d.(8).(13) <- 422; d.(8).(14) <- 288; d.(8).(15) <- 282; d.(8).(16) <- 307;
  d.(8).(17) <- 414; d.(8).(18) <- 289; d.(8).(19) <- 255; d.(8).(2) <- 393; d.(8).(20) <- 310;
  d.(8).(21) <- 406; d.(8).(3) <- 279; d.(8).(4) <- 334; d.(8).(5) <- 152; d.(8).(6) <- 300;
  d.(8).(7) <- 287; d.(8).(9) <- 275; d.(9).(0) <- 309; d.(9).(1) <- 253; d.(9).(10) <- 345;
  d.(9).(11) <- 280; d.(9).(12) <- 309; d.(9).(13) <- 272; d.(9).(14) <- 263; d.(9).(15) <- 237;
  d.(9).(16) <- 287; d.(9).(17) <- 419; d.(9).(18) <- 295; d.(9).(2) <- 398; d.(9).(20) <- 270;
  d.(9).(21) <- 416; d.(9).(3) <- 314; d.(9).(4) <- 323; d.(9).(5) <- 244; d.(9).(6) <- 294;
  d.(9).(7) <- 266;  d.(9).(8) <- 259;
  ()

let () =
  let s (x, y) = (y, x) in
  p.(0) <- s (51.5073219,-0.1276474);
  p.(1) <- s (52.5170365,13.3888599);
  p.(2) <- s (40.4167047,-3.7035825);
  p.(3) <- s (41.8933439,12.4830718);
  p.(4) <- s (48.8565056,2.3521334);
  p.(5) <- s (48.2083537,16.3725042);
  p.(6) <- s (44.436139,26.1027436);
  p.(7) <- s (53.5437641,10.0099133);
  p.(8) <- s (47.4983815,19.0404707);
  p.(9) <- s (52.2319237,21.0067265);
  p.(10) <- s (41.3825596,2.1771353);
  p.(11) <- s (48.1372719,11.5754815);
  p.(12) <- s (45.466797,9.1905368);
  p.(13) <- s (42.6977211,23.3225964);
  p.(14) <- s (50.0874401,14.4212556);
  p.(15) <- s (55.6867243,12.5700724);
  p.(16) <- s (50.84404145,4.36720169448285);
  p.(17) <- s (52.4813679,-1.8980726);
  p.(18) <- s (50.9383611,6.9599738);
  p.(19) <- s (40.8441164,14.2422998);
  p.(20) <- s (59.3251172,18.0710935);
  p.(21) <- s (45.0709201,7.685972);
  ()

let names = [| "London"; "Berlin"; "Madrid"; "Rome"; "Paris"; "Vienna";
  "Bucharest"; "Hamburg"; "Budapest"; "Warsaw"; "Barcelona"; "Munich";
  "Milan"; "Sofia"; "Prague"; "Copenhagen"; "Brussels"; "Birmingham";
  "Cologne"; "Naples"; "Stockholm"; "Turin" |]

let bounds l = (List.fold_left min 180. l -. 2., List.fold_left max (-.180.) l +. 2.)

let ((xmin, xmax), (ymin, ymax)) =
  let l = Array.to_list p in
  (bounds (List.map fst l), bounds (List.map snd l))


let () = open_graph " 600x400"

let (w, h) = (size_x (), size_y ())

let act f (x, y) = f x y

let scale x (xmin, xmax) w = truncate ((x -. xmin) /. (xmax -. xmin) *. float w)
let unscale x (xmin, xmax) w = float x /. float w *. (xmax -. xmin) +. xmin

let toscreen (x, y) = (scale x (xmin, xmax) w, scale y (ymin, ymax) h)
let fromscreen (x, y) = (unscale x (xmin, xmax) w, unscale y (ymin, ymax) h)

let iter_position f = Array.iteri f p
let iter_duration f = Array.iteri (fun i v -> Array.iteri (f i) v) d

let draw_cities () =
  iter_position (fun i pos ->
    act draw_circle (toscreen pos) 4;
  )

let gray = rgb 127 127 127

let dist (x, y) (x', y') = sqrt ((x -. x') *. (x -. x') +. (y -. y') *. (y -. y'))

let () =
  for i = 0 to 21 do
    for j = 0 to i-1 do
      printf "%d (%s - %s : aller=%d retour=%d\n" (abs (d.(i).(j) - d.(j).(i)))
        names.(i) names.(j) d.(i).(j) d.(j).(i)
    done
  done

let u () =
  let ok = ref true in
  auto_synchronize false;
  (* try set_font "arial" with _ -> (); *)
  while !ok do
    let e = wait_next_event [Mouse_motion; Key_pressed; Poll] in
    if e.keypressed then ok := false;
    let mouse = (e.mouse_x, e.mouse_y) in
    clear_graph ();
    
    let timetoreachtown = Array.make 22 (1.e9, "") in
    let newway i (time, way) = if time < fst timetoreachtown.(i) then timetoreachtown.(i) <- (time, way) in
    
    let speed = 0.012 in
    
    iter_position (fun i pos ->
      newway i (dist (fromscreen mouse) p.(i) /. speed, ""));
    
    set_color gray;
    
    let radius_from_time time = truncate ((time *. speed) /. (xmax -. xmin) *. float w) in
    
    iter_duration (fun o d flighttime ->
      let time = dist (fromscreen mouse) (p.(o)) /. speed +. float flighttime in
      newway d (time, sprintf "(via %s)" names.(o)));
    
    let maxh = 15 in
    let draw_iso h =
      let time = 60. *. float h in
      set_color (let x = 200 - (maxh - h) * 150 / maxh in rgb x x x);
      act fill_circle mouse (radius_from_time time);
      iter_position (fun i pos ->
        let rad = radius_from_time (time -. fst timetoreachtown.(i)) in
        if rad > 0 then act fill_circle (toscreen p.(i)) rad
      )
    in
    for h = maxh/3 downto 1 do draw_iso (h * 3) done;
    
    set_color black;
    
    iter_position (fun i pos ->
      act moveto (toscreen pos);
      let (time, way) = timetoreachtown.(i) in
      
      act moveto (toscreen pos); rmoveto 7 (-5+ 0);    draw_string names.(i);
      act moveto (toscreen pos); rmoveto 7 (-5+ -11); draw_string (sprintf "%.2fh" (time/.60.));
      act moveto (toscreen pos); rmoveto 7 (-5+ -22); draw_string (sprintf "%s" way)
    );
    
    draw_cities ();
    synchronize ()
  done
